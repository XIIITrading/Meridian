import{V as H,a8 as E,S as Se,jc as G,g1 as k,gY as Fe,f_ as B,aj as R,ji as ge,im as Qe,jj as Ve,G as we,r as n,cd as _e,f as je,u as be,J as Ae,am as qe,n as a,aP as D,aH as f,jk as Ce,jl as Pe,L as z,aQ as Y,Y as ke,fp as Re,jm as Ee}from"./DOFFjK0_.js";import{u as Te}from"./SJHyi9T4.js";function Ue(){const v=H(),{isMysql:o,isPg:_}=v,{sqlUis:F}=E(v),{metas:j}=Se(),g={field:"",query:"",isValidFieldQuery:!0},d=G("field-query-search-map",()=>({})),b=G("field-query-search",()=>({...g}));return{search:b,loadFieldQuery:(r,u=!1)=>{r&&((u||!(r in d.value))&&(d.value[r]={...g}),b.value=d.value[r])},getValidSearchQueryForColumn:(r,u,c,h={})=>{if(!k(u))return"";let l=u;try{l=Fe.serializeValue(l,{col:r,isMysql:o,isPg:_,meta:c,metas:j.value,serializeSearchQuery:!0})}catch{B(r)?r.uidt!==R.Formula&&(l=u):(l="",console.log("invalid search query for column",r.title,l))}if(B(r)&&r.uidt!==R.Formula&&!k(l)&&(l=u),!k(l))return"";if(!h.getWhereQueryAs)return l??"";const m=c!=null&&c.source_id?F.value[c.source_id]:Object.values(F.value)[0];return(r.uidt!==R.Formula||ge(r)!==Qe.NUMERIC)&&!Ve(r)&&m&&["text","string"].includes(m.getAbstractType(r))&&r.dt!=="bigint"?h.getWhereQueryAs==="object"?{fk_column_id:r.id,comparison_op:"like",value:l??""}:`(${r.title},like,%${l}%)`:h.getWhereQueryAs==="object"?{fk_column_id:r.id,comparison_op:"eq",value:l??""}:`(${r.title},eq,${l})`}}}const[Le,We]=Te((v,o,_=!1,F,j)=>{const g=we(_e,n(!1)),{$api:d}=je(),Q=be().currentRoute,{user:T,isMobileMode:r}=Ae(),{activeView:u,activeNestedFilters:c,activeSorts:h}=E(qe()),l=H(),{sqlUis:m,base:U}=E(l),K=a(()=>{var e;return(e=o.value)!=null&&e.source_id?m.value[o.value.source_id]:Object.values(m.value)[0]}),{search:y,getValidSearchQueryForColumn:W}=Ue(),J=Re(Ee.SmartsheetStore),X=a(()=>{var e,s,t,i;return((e=u.value)==null?void 0:e.lock_type)===D.Personal&&((s=T.value)==null?void 0:s.id)!==((t=u.value)==null?void 0:t.owned_by)||((i=u.value)==null?void 0:i.lock_type)===D.Locked}),Z=a(()=>{var e,s;return(s=(e=o.value)==null?void 0:e.columns)==null?void 0:s.some(t=>t.pk)}),N=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.GRID}),O=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.FORM}),$=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.GALLERY}),I=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.CALENDAR}),ee=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.KANBAN}),se=a(()=>{var e;return((e=u.value)==null?void 0:e.type)===f.MAP}),re=a(()=>O.value&&_),te=a(()=>{var e;return(e=u.value)==null?void 0:e.is_default}),ae=n(!0),ue=a(()=>{var e,s;return!!((s=(e=U.value)==null?void 0:e.sources)!=null&&s.some(t=>{var i;return t.id===((i=o.value)==null?void 0:i.source_id)&&!t.is_meta&&!t.is_local}))}),le=n(!1),oe=a(()=>{var s,t;return(t=((s=o.value)==null?void 0:s.columns)||[])==null?void 0:t.reduce((i,S)=>(i[S.title]=S,i),{})}),V=a(()=>{if(Q.value.query.where)return Ce({api_version:Pe.V1},Q.value.query.where,oe.value,!1)}),ie=a(()=>{var e,s,t;return(s=(e=V.value)==null?void 0:e.errors)!=null&&s.length?[]:((t=V.value)==null?void 0:t.filters)||[]}),A=a(()=>{var e,s;if(!((s=(e=V.value)==null?void 0:e.errors)!=null&&s.length))return Q.value.query.where}),ne=n(0),ce=n(0),ve=a(()=>{var e;return((e=y.value.query)==null?void 0:e.trim())&&!r.value&&(N.value||$.value)}),de=a(()=>{var S,L,M,x;let e;A.value&&(e=A.value);const s=((L=(S=o.value)==null?void 0:S.columns)==null?void 0:L.find(({id:P})=>P===y.value.field))||((x=(M=o.value)==null?void 0:M.columns)==null?void 0:x.find(P=>P.pv)),t=y.value.query.trim();if(!s||!t)return y.value.isValidFieldQuery=!0,e;const i=W(s,t,o.value,{getWhereQueryAs:"string"});return i?(y.value.isValidFieldQuery=!0,`${e?`${e}~and`:""}${i}`):(y.value.isValidFieldQuery=!1,e)}),ye=n(!1),fe=n(40),he=a(()=>{var e;return((e=o.value)==null?void 0:e.type)==="view"}),me=a(()=>{var e;return!!((e=o.value)!=null&&e.synced)}),q=n(z(F)??[]),C=n(z(j)??[]),pe=n([]);Y(q,()=>{h.value=q.value},{immediate:!0}),Y(C,()=>{c.value=C.value},{immediate:!0});const w=ke({}),p=new Map;return{view:u,meta:o,isLocked:X,$api:d,xWhere:de,isPkAvail:Z,isForm:O,isGrid:N,isGallery:$,isKanban:ee,isMap:se,isCalendar:I,isSharedForm:re,sorts:q,nestedFilters:C,isSqlView:he,eventBus:J,sqlUi:K,allFilters:pe,isDefaultView:te,actionPaneSize:fe,isActionPaneActive:ye,viewColumnsMap:w,getViewColumns:async e=>{if(g.value)return[];if(w[e])return w[e];if(p.has(e))return p.get(e);const s=d.dbViewColumn.list(e).then(t=>(w[e]=t.list,p.delete(e),t.list)).catch(t=>{throw p.delete(e),t});return p.set(e,s),s},isExternalSource:ue,isAlreadyShownUpgradeModal:le,filtersFromUrlParams:V,whereQueryFromUrl:A,validFiltersFromUrlParams:ie,isSyncedTable:me,totalRowsWithSearchQuery:ne,totalRowsWithoutSearchQuery:ce,fetchTotalRowsWithSearchQuery:ve,gridEditEnabled:ae,getValidSearchQueryForColumn:W}},"smartsheet-store");function Me(){const v=We();if(!v)throw new Error("Please call `useProvideSmartsheetStore` on the appropriate parent component");return v}export{Le as a,Ue as b,Me as u};
