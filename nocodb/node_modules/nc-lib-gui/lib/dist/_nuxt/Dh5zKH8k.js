var Me=Object.defineProperty;var Oe=(i,o,u)=>o in i?Me(i,o,{enumerable:!0,configurable:!0,writable:!0,value:u}):i[o]=u;var de=(i,o,u)=>Oe(i,typeof o!="symbol"?o+"":o,u);import{aj as l,eT as fe,b0 as me,jo as $e,hH as ye,iD as T,jp as he,du as Re,a6 as je,f as Ne,J as Ce,a8 as Je,V as Ve,gj as xe,S as ze,G as ve,r as N,jb as Ee,n as C,as as Pe,dJ as Ue,fQ as Fe,j1 as Ke,gJ as qe,aQ as Qe,$ as He,gH as E,a4 as Q,a5 as H}from"./DOFFjK0_.js";import{u as Ye}from"./SJHyi9T4.js";import{u as Xe}from"./B3Wp9c04.js";import{u as Ze}from"./DG2ZEhLK.js";import{e as ge}from"./D2QgEzTv.js";const P=(i,o,u)=>o.uidt===l.Checkbox?i?T.TRUE:T.FALSE:[l.User,l.CreatedBy,l.LastModifiedBy].includes(o.uidt)&&!i?T.NULL:o.uidt===l.LinkToAnotherRecord&&u&&i&&typeof i=="object"?i[u]??T.NULL:(i&&typeof i=="object"&&(i=JSON.stringify(i)),i??T.NULL),We=(i,o,u)=>{var v,B;if(o)switch(o.uidt){case l.MultiSelect:{const k=(i==null?void 0:i.split(","))||[],g=[];for(const I of k){const S=(v=o.colOptions.options)==null?void 0:v.find(p=>p.title===I);S&&g.push(S.color)}return g.join(",")}case l.SingleSelect:{const k=(B=o.colOptions.options)==null?void 0:B.find(g=>g.title===i);return k?k.color||u():"gray"}case l.Checkbox:return i==="__nc_true__"?he.success:he.error;default:return i?u():"gray"}return i?u():"gray"},rt=i=>[l.Lookup,l.Attachment,l.Barcode,l.QrCode,l.Links,l.User,l.DateTime,l.CreatedTime,l.LastModifiedTime,l.CreatedBy,l.LongText,l.LastModifiedBy].includes(typeof i=="object"?i==null?void 0:i.uidt:i),ct=i=>{var u,v,B,k,g,I,S,p,M;let o=((i==null?void 0:i.key)??(i==null?void 0:i.value)).toString();if(o&&((u=i.column)==null?void 0:u.uidt)===l.Lookup||((v=i.column)==null?void 0:v.uidt)===l.LinkToAnotherRecord)try{o=JSON.parse(o)}catch{return o.split("___")}if(o&&((B=i.column)==null?void 0:B.uidt)===l.DateTime)return[fe(o,`${((g=me((k=i.column)==null?void 0:k.meta))==null?void 0:g.date_format)??$e[0]} ${((S=me((I=i.column)==null?void 0:I.meta))==null?void 0:S.time_format)??ye[0]}`)];if(o&&((p=i.column)==null?void 0:p.uidt)===l.Time)return[fe(o,ye[0],!1)];if(o&&[l.User,l.CreatedBy,l.LastModifiedBy].includes((M=i.column)==null?void 0:M.uidt))try{return[JSON.parse(o)]}catch{return null}return[o]};class pe{constructor(){de(this,"aliasMap",new Map)}generateAlias(o){const u=Math.random().toString(36).substring(2,15);return this.aliasMap.set(u,o),u}getAlias(o){return this.aliasMap.get(o)}clear(){this.aliasMap.clear()}async process(o,u){for(const[v,B]of Object.entries(o)){const k=this.getAlias(v);k!==void 0&&await u(k,B)}}}const et=[l.Attachment,l.QrCode,l.Barcode,l.Button],[ut,tt]=Ye((i,o,u,v=!1)=>{const k=Re(),{api:g}=je(),{$api:I}=Ne(),{appInfo:S}=Ce(),{base:p}=Je(Ve()),{sharedView:M,fetchSharedViewData:Y,fetchBulkAggregatedData:X}=xe(),{gridViewCols:U}=Xe(),{getMeta:F}=ze(),ke=ve(Ee,N(null)),y=C(()=>{const t=[];return Object.values(U.value).forEach(e=>{var n,s;if(e.group_by){const c=(s=(n=o==null?void 0:o.value)==null?void 0:n.columns)==null?void 0:s.find(d=>d.id===e.fk_column_id);c&&t.push({column:c,sort:e.group_by_sort||"asc",order:e.group_by_order||1})}}),t.sort((e,n)=>(e.order??1/0)-(n.order??1/0)),t}),_e=C(()=>!!y.value.length),{isUIAllowed:b}=Pe(),{sorts:J,nestedFilters:G}=Ze(),K=ve(Fe,Ue()),D=C(()=>{var t;return((t=S.value.defaultGroupByLimit)==null?void 0:t.limitGroup)||25}),O=C(()=>{var t;return((t=S.value.defaultGroupByLimit)==null?void 0:t.limitRecord)||10}),Z=N([]),we=C(()=>{var t;return k(((t=o==null?void 0:o.value)==null?void 0:t.columns)||[]).map(e=>(e.uidt===l.Lookup&&e.id&&Z.value.includes(e.id)||et.includes(e.uidt)?(e.ncItemDisabled=!0,e.ncItemTooltip=`This Field of type ${Ke[e.uidt]} not supported for grouping`):(e.ncItemDisabled=!1,e.ncItemTooltip=""),e))}),_=N({key:"root",color:"root",count:0,column:{},nestedIn:[],aggregations:{},paginationData:{page:1,pageSize:D.value},nested:!0,children:[],root:!0});async function W(t,e){e=e||_.value,e&&(e.paginationData.page=t,await te({offset:(t-1)*(e.paginationData.pageSize||D.value)},e))}const Se=t=>t.map(e=>({row:{...e},oldRow:{...e},rowMeta:{}})),$=N(qe.light),V=N($.value[0]),De=()=>{const t=V.value,e=$.value.indexOf(V.value);return e===$.value.length-1?V.value=$.value[0]:V.value=$.value[e+1],t},x=(t,e="")=>t.reduce((n,s)=>{if(s.key===T.NULL)n+=`${n.length?"~and":""}(${s.title},gb_null)`;else if(s.column_uidt===l.Checkbox)n+=`${n.length?"~and":""}(${s.title},${s.key===T.TRUE?"checked":"notchecked"})`;else if([l.Date,l.DateTime,l.CreatedTime,l.LastModifiedTime].includes(s.column_uidt))n+=`${n.length?"~and":""}(${s.title},gb_eq,exactDate,${s.key})`;else if([l.User,l.CreatedBy,l.LastModifiedBy].includes(s.column_uidt))try{const c=JSON.parse(s.key);n+=`${n.length?"~and":""}(${s.title},gb_eq,${(Array.isArray(c)?c:[c]).map(d=>d.id).join(",")})`}catch(c){console.error(c)}else n+=`${n.length?"~and":""}(${s.title},gb_eq,${s.key})`;return n},e),ee=t=>{if(t==="asc")return"+";if(t==="desc")return"-";if(t==="count-asc")return"~+";if(t==="count-desc")return"~-"},Ae=async(t,e)=>{var d;e=e||_.value;const n=y.value[e.nestedIn.length];if(!n)return e;const s=t.list.reduce((a,r)=>{const f=a.find(w=>w.key===P(r[n.column.column_name]??r[n.column.title],n.column));return f?(f.count+=+r.count,f.paginationData={page:1,pageSize:e.paginationData.pageSize||D.value,totalRows:f.count},a):(n.column.title&&n.column.uidt&&a.push({key:P(r[n.column.title],n.column),column:n.column,count:+r.count,color:We(r[n.column.title],n.column,De),nestedIn:[...e.nestedIn,{title:n.column.title,column_name:n.column.title,key:P(r[n.column.title],n.column),column_uidt:n.column.uidt}],aggregations:r.aggregations??{},paginationData:{page:1,pageSize:e.nestedIn.length<y.value.length-1?e.paginationData.pageSize||D.value:O.value,totalRows:+r.count},nested:e.nestedIn.length<y.value.length-1}),a)},[]);e.children||(e.children=[]);for(const a of s){const r=(d=e.children)==null?void 0:d.find(f=>f.key===a.key);if(r){a.paginationData={page:r.paginationData.page||a.paginationData.page,pageSize:r.paginationData.pageSize||a.paginationData.pageSize,totalRows:a.count},Object.assign(r,a);continue}e.children.push(a)}e.children=e.children.filter(a=>s.find(r=>r.key===a.key)),e.count<=(e.paginationData.pageSize??D.value)&&e.children.sort((a,r)=>{const f=s.findIndex(m=>m.key===a.key),w=s.findIndex(m=>m.key===r.key);return f-w}),e.paginationData=t.pageInfo;const c=Math.max(1,Math.ceil(e.paginationData.totalRows/e.paginationData.pageSize));return c<e.paginationData.page&&await W(c,e),e};async function te(t={},e,n){var s,c,d,a,r,f,w,m;try{if(e=e||_.value,!((s=p==null?void 0:p.value)!=null&&s.id)||!((c=i.value)!=null&&c.id)||!((d=i.value)!=null&&d.fk_model_id)||!e)return;if(y.value.length===0){e.children=[];return}if(e.nestedIn.length>y.value.length)return;const h=y.value[e.nestedIn.length],R=x(e.nestedIn,u==null?void 0:u.value);if(!h||!h.column.title||v&&!((a=M.value)!=null&&a.uuid))return;if(h.column.uidt===l.LinkToAnotherRecord){const L=await F(h.column.colOptions.fk_related_model_id);if(!L)return;e.displayValueProp=((w=((r=L.columns)==null?void 0:r.find(j=>j.pv))||((f=L.columns)==null?void 0:f[0]))==null?void 0:w.title)||""}const q=v?await g.public.dataGroupBy(M.value.uuid,{offset:((e.paginationData.page??0)-1)*D.value,limit:D.value,...t,where:R,sort:`${ee(h.sort)}${h.column.title}`,column_name:h.column.title,sortsArr:J.value,filtersArr:G.value},{headers:{"xc-password":ke.value}}):await g.dbViewRow.groupBy("noco",p.value.id,i.value.fk_model_id,i.value.id,{offset:((e.paginationData.page??0)-1)*D.value,limit:D.value,...t,...b("sortSync")?{}:{sortArrJson:JSON.stringify(J.value)},...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)},where:`${R}`,sort:`${ee(h.sort)}${h.column.title}`,column_name:h.column.title});if(e=await Ae(q,e),S.value.ee&&((m=e==null?void 0:e.children)!=null&&m.length)){const L=new pe,j=Object.values(U.value).map(A=>({field:A.fk_column_id,type:A.aggregation??E.None})).filter(A=>A.type!==E.None),re=(e.children??[]).map(A=>({where:x(A.nestedIn,u==null?void 0:u.value),alias:L.generateAlias(A.key),...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}}));let ce={};j.length&&(ce=v?await X({aggregation:j},re):await g.dbDataTableBulkAggregate.dbDataTableBulkAggregate(o.value.id,{viewId:i.value.id,aggregation:j},re),await L.process(ce,(A,Ge)=>{const ue=((e==null?void 0:e.children)??[]).find(Le=>Le.key.toString()===A.toString());ue&&Object.assign(ue.aggregations,Ge)}))}}catch(h){console.log(h),Q.error(await H(h))}}async function ne(t,e=!1,n={}){var s,c,d;try{if(!((s=p==null?void 0:p.value)!=null&&s.id)||!((c=i.value)!=null&&c.id)||!((d=i.value)!=null&&d.fk_model_id)||t.children&&!e)return;t.paginationData||(t.paginationData={page:1,pageSize:O.value});const a=x(t.nestedIn,u==null?void 0:u.value),r={offset:((t.paginationData.page??0)-1)*(t.paginationData.pageSize??O.value),limit:t.paginationData.pageSize??O.value,where:`${a}`},f=v?await Y({sortsArr:J.value,filtersArr:G.value,...r},{isGroupBy:!0}):await g.dbViewRow.list("noco",p.value.id,i.value.fk_model_id,i.value.id,{...r,...n,...b("sortSync")?{}:{sortArrJson:JSON.stringify(J.value)},...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}});t.count=f.pageInfo.totalRows??0,t.rows=Se(f.list),await Ie(t.rows),t.paginationData=f.pageInfo}catch(a){Q.error(await H(a))}}async function Be(t,e){var n,s,c,d;try{if(!((n=o==null?void 0:o.value)!=null&&n.id)||!((s=i.value)!=null&&s.id)||!((c=i.value)!=null&&c.fk_model_id)||!S.value.ee)return;let a=e;if(e||(a=Object.values(U.value).map(m=>({field:m.fk_column_id,type:m.aggregation??E.None}))),a=a==null?void 0:a.filter(m=>m.type!==E.None),a&&!(a!=null&&a.length)||!((d=t.children)!=null&&d.length))return;const r=new pe,f=(t.children??[]).map(m=>({where:x(m.nestedIn,u==null?void 0:u.value),alias:r.generateAlias(m.key),...b("filterSync")?{}:{filterArrJson:JSON.stringify(G.value)}})),w=v?await X({...a?{aggregation:a}:{}},f):await g.dbDataTableBulkAggregate.dbDataTableBulkAggregate(o.value.id,{viewId:i.value.id,...a?{aggregation:a}:{}},f);await r.process(w,(m,h)=>{const R=(t.children??[]).find(q=>q.key.toString()===m.toString());R&&Object.assign(R.aggregations,h)})}catch(a){Q.error(await H(a))}}const be=async(t,e)=>{t.paginationData||(t.paginationData={page:1,pageSize:O.value}),t.paginationData.page=e,await ne(t,!0)},ae=(t,e=0)=>{if(t=t||_.value,!!t&&(e<y.value.length?t.nested=!0:t.nested=!1,t.nested?t!=null&&t.rows&&(t.rows=[]):t!=null&&t.children&&(t.children=[]),!(e>y.value.length)))for(const n of t.children||[])ae(n,e+1)};Qe(()=>y.value.length,async()=>{y.value.length&&(_.value.paginationData={page:1,pageSize:D.value},_.value.column={},ae(),He(()=>K==null?void 0:K.trigger()))});const ie=(t,e,n=0)=>{var c;if(e=e||_.value,n>=t.length)return e;const s=(c=e.children)==null?void 0:c.find(d=>d.key===t[n].key);return s?s.nested?ie(t,s,n+1):s:e},se=t=>ie(t.nestedIn.slice(0,-1)),z=(t,e)=>{var n;if(t){if(t.count+=e,t.count===0){const s=se(t);s&&(s.children=(n=s.children)==null?void 0:n.filter(c=>c.key!==t.key))}t.root||z(se(t),e)}},oe=(t,e,n=0)=>{var s;if(e=e||_.value,e.nested){const c=(s=e.children)==null?void 0:s.find(d=>{if(y.value[n].column.title)return d.key===P(t.row[y.value[n].column.title],y.value[n].column,e.displayValueProp)});return c?oe(t,c,n+1):{found:!1,group:e}}return{found:!0,group:e}},le=t=>{var e;t=t||_.value,t&&(!t.nested&&t.rows?t.rows.forEach(n=>{var c,d,a,r;const s=oe(n);s.found?s.group!==t&&(s.group&&((c=s.group.rows)==null||c.push(n),z(s.group,1)),t&&((d=t.rows)==null||d.splice(t.rows.indexOf(n),1),z(t,-1))):t?((a=t.rows)==null||a.splice(t.rows.indexOf(n),1),z(t,-1)):(r=_.value.rows)==null||r.splice(_.value.rows.indexOf(n),1)}):(e=t.children)==null||e.forEach(n=>le(n)))},Te=async()=>{var e,n,s,c;const t=[];try{for(const d of((e=o==null?void 0:o.value)==null?void 0:e.columns)||[]){if(d.uidt!==l.Lookup)continue;let a=d;for(;a&&a.uidt===l.Lookup;){const r=(s=(n=await F(a.fk_model_id))==null?void 0:n.columns)==null?void 0:s.find(w=>w.id===(a==null?void 0:a.colOptions).fk_relation_column_id);if(!(r!=null&&r.colOptions))break;const f=await F((r==null?void 0:r.colOptions).fk_related_model_id);if(a=(c=f==null?void 0:f.columns)==null?void 0:c.find(w=>w.id===(a==null?void 0:a.colOptions).fk_lookup_column_id),(a==null?void 0:a.id)===d.id)break}((a==null?void 0:a.uidt)===l.Attachment||!a)&&d.id&&t.push(d.id)}Z.value=t}catch(d){console.error(d)}};async function Ie(t){if(!b("commentCount")||v.value)return;const e=t.filter(({rowMeta:{new:n}})=>!n).map(({row:n})=>{var s;return ge(n,(s=o==null?void 0:o.value)==null?void 0:s.columns)}).filter(Boolean);if(e.length)try{const n=await I.utils.commentCount({ids:e,fk_model_id:o.value.id});t.forEach(s=>{var a,r;const c=ge(s.row,(a=o.value)==null?void 0:a.columns),d=((r=n==null?void 0:n.find(f=>f.row_id===c))==null?void 0:r.count)||0;s.rowMeta=s.rowMeta??{},s.rowMeta.commentCount=+d})}catch(n){console.error("Failed to load aggregate comment count:",n)}}return{rootGroup:_,groupBy:y,isGroupBy:_e,fieldsToGroupBy:we,groupByLimit:3,loadGroups:te,loadGroupData:ne,loadGroupPage:be,loadGroupAggregation:Be,groupWrapperChangePage:W,redistributeRows:le,loadDisallowedLookups:Te}},"useViewGroupBy");function dt(){const i=tt();if(i==null)throw new Error("Please call `useProvideViewGroupBy` on the appropriate parent component");return i}export{pe as A,dt as a,We as f,ct as p,rt as s,ut as u,P as v};
