import{as as Qe,J as Ie,n as V,r as w,cm as ze,Y as De,de as ge,ah as Be,a6 as Ge,V as ke,a8 as Le,f as We,a9 as qe,W as Ue,G as Xe,cd as Ke,gj as ea,aj as J,gX as aa,aQ as j,fS as Ye,a4 as H,a5 as W,im as be,aC as ta,f_ as la,gn as ra}from"./DOFFjK0_.js";import{u as sa}from"./SJHyi9T4.js";import{b as ua,u as na}from"./DG2ZEhLK.js";import{b as oa}from"./C1uRXLg7.js";import{e as de,r as ia}from"./D2QgEzTv.js";const ce=(n,f)=>n.map(Q=>({row:{...Q},oldRow:{...Q},rowMeta:{...(f==null?void 0:f(Q))??{}}})),[pa,da]=sa((n,f,Q=!1,C)=>{if(!n)throw new Error("Table meta is not available");const{isUIAllowed:q}=Qe(),{isMobileMode:Se}=Ie(),{getValidSearchQueryForColumn:Te}=ua(),I=V(()=>{var e,a;return(a=(e=n.value)==null?void 0:e.columns)==null?void 0:a.find(t=>t.pv)}),v=w(),h=w([]),U=V(()=>{var e,a;return!h.value||!h.value[0]?null:(a=(e=h.value[0])==null?void 0:e.fk_from_col)==null?void 0:a.uidt}),B=V(()=>{var e,a,t;return!h.value||!h.value[0]?ze.tz.guess():((t=(a=(e=h.value[0])==null?void 0:e.fk_from_col)==null?void 0:a.meta)==null?void 0:t.timezone)??ze.tz.guess()}),s=De(ge(Be,B==null?void 0:B.value)),N=De({value:"",field:"",isValidFieldQuery:!0}),te=V(()=>{var a;if(!I.value||!((a=N.value)!=null&&a.trim())){N.isValidFieldQuery=!0;return}const e=Te(I.value,N.value.trim(),n.value,{getWhereQueryAs:"object"});if(!e){N.isValidFieldQuery=!1;return}return e}),y=w(s.dayjsTz()),r=w(s.dayjsTz()),b=w(s.dayjsTz()),g=w(s.dayjsTz()),le=w(!1),re=w(!1),$=w(!Se.value),_=w({start:s.dayjsTz(r.value).startOf("week"),end:s.dayjsTz(r.value).startOf("week").add(6,"day")}),ve=25,G=w([]),F=w([]),X=w(!1),se=w([]),O=w(v.value??"allRecords"),{api:K}=Ge(),{isMysql:je}=ke(),{base:p}=Le(ke()),{$api:ue,$e:fe}=We(),{t:ee}=qe(),{addUndo:Re,clone:me,defineViewScope:He}=Ue(),R=w(Q)||Xe(Ke,w(!1)),{sorts:ae,nestedFilters:E,isSyncedTable:Ve,eventBus:Fe}=na(),{sharedView:Ae,fetchSharedViewData:ye,fetchSharedViewActiveDate:xe,fetchSharedCalendarViewData:Me}=ea(),{getEvaluatedRowMetaRowColorInfo:Z}=oa(),T=w({}),pe=w({page:1,pageSize:ve}),ne=V(()=>({limit:pe.value.pageSize??ve,where:(C==null?void 0:C.value)??""})),Pe=V(()=>{var e;return je((e=n.value)==null?void 0:e.source_id)?"YYYY-MM-DD HH:mm:ss":"YYYY-MM-DD HH:mm:ssZ"}),oe=V(()=>{var a;let e=((a=T.value)==null?void 0:a.meta)??{};if(typeof e=="string")try{e=JSON.parse(e)}catch{}return e}),L=V(()=>{let e=[];if(!h.value)return[];if(O.value==="allRecords")e=[];else if(O.value==="withoutDates")h.value.forEach(a=>{const t=a.fk_from_col,l=a.fk_to_col;if(!t)return;const u=[];t&&u.push({fk_column_id:t.id,logical_op:"or",comparison_op:"blank"}),l&&u.push({fk_column_id:l.id,logical_op:"or",comparison_op:"blank"}),e=[...e,...u]}),e=[{is_group:!0,logical_op:"or",children:e}];else if(O.value==="week"||O.value==="month"||O.value==="day"||O.value==="year"||O.value==="selectedDate"||O.value==="selectedHours"){let a=null,t=null,l=null,u=null;switch(O.value){case"day":case"selectedDate":t=r.value.startOf("day"),l=r.value.endOf("day"),a=r.value.subtract(1,"day").endOf("day"),u=r.value.add(1,"day").startOf("day");break;case"week":t=_.value.start.startOf("week"),l=_.value.end.endOf("week"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=s.timezonize(l.add(1,"day")).startOf("day");break;case"month":{const i=s.timezonize(g.value.startOf("month")),m=s.timezonize(i.startOf("week")),d=s.timezonize(g.value.endOf("month")).endOf("week");t=m,l=d,a=t.subtract(1,"day").endOf("day"),u=l.add(1,"day").startOf("day");break}case"year":t=r.value.startOf("year"),l=r.value.endOf("year"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=l.add(1,"day").startOf("day");break;case"selectedHours":t=s.timezonize((b.value??s.dayjsTz()).startOf("hour")),l=s.timezonize((b.value??s.dayjsTz()).endOf("hour")),a=s.timezonize(t==null?void 0:t.subtract(1,"hour").endOf("hour")),u=s.timezonize(l==null?void 0:l.add(1,"hour").startOf("hour"));break}if(t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),u=s.dayjsTz(u).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ"),U.value===J.Date){const i=/^\d{4}-\d{2}-\d{2}/;t=t.match(i)[0],l=l.match(i)[0],u=u.match(i)[0],a=a.match(i)[0]}h.value.forEach(i=>{const m=i.fk_from_col,d=i.fk_to_col;let c=[];m&&d?(c=[{is_group:!0,logical_op:"and",children:[{fk_column_id:m.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:u},{fk_column_id:d.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:a}]},{is_group:!0,logical_op:"or",children:[{fk_column_id:m.id,comparison_op:"gte",comparison_sub_op:"exactDate",value:t},{fk_column_id:m.id,comparison_op:"lte",comparison_sub_op:"exactDate",value:l}]}],e.push({is_group:!0,logical_op:"or",children:c})):m&&(c=[{fk_column_id:m.id,comparison_op:"lt",comparison_sub_op:"exactDate",value:u},{fk_column_id:m.id,comparison_op:"gt",comparison_sub_op:"exactDate",value:a}],e.push({is_group:!0,logical_op:"and",children:c}))})}return I.value&&aa(te.value)&&(e.length>0?e=[{is_group:!0,logical_op:"and",children:[...e,te.value]}]:e.push(te.value)),e});async function Ee(e={}){var a,t,l,u;if(!((!((a=p==null?void 0:p.value)!=null&&a.id)||!((t=n.value)!=null&&t.id)||!((l=f.value)!=null&&l.id))&&!R.value||!((u=h.value)!=null&&u.length))&&!X.value)try{const i=R.value?await ye({...e,sortsArr:ae.value,filtersArr:[...E.value,...L.value],offset:e.offset}):await K.dbViewRow.list("noco",p.value.id,n.value.id,f.value.id,{...e,offset:e.offset,...q("filterSync")?{filterArrJson:JSON.stringify([...L.value])}:{filterArrJson:JSON.stringify([E.value,...L.value])}});F.value=[...F.value,...ce(i.list,Z)]}catch(i){console.log(i)}}const A=async()=>{var u,i,m,d,c,D,k;if(v.value==="month"||!((u=p==null?void 0:p.value)!=null&&u.id)||!((i=n.value)!=null&&i.id)||!((m=f.value)!=null&&m.id)||!((d=h.value)!=null&&d.length))return;let e=null,a=null,t=null,l=null;if(v.value==="week"||v.value==="day"){const o=s.timezonize(y.value.startOf("month"));a=s.timezonize(o.startOf("week")),t=s.timezonize(y.value.endOf("month").endOf("week")),e=a.subtract(1,"day").endOf("day"),l=t.startOf("day")}else if(v.value==="year"){const o=s.timezonize(r.value.startOf("year"));a=s.timezonize(o.startOf("week")),t=s.timezonize(r.value.endOf("year")).endOf("week"),e=a.subtract(1,"day").endOf("day"),l=t.startOf("day")}if(e=s.dayjsTz(e).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ"),a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),!(!((c=p==null?void 0:p.value)!=null&&c.id)||!((D=n.value)!=null&&D.id)||!((k=f.value)!=null&&k.id)))try{const o=R.value?await xe({from_date:e,to_date:l,next_date:l,prev_date:e,sortsArr:ae.value,filtersArr:E.value}):await K.dbCalendarViewRowCount.dbCalendarViewRowCount("noco",p.value.id,n.value.id,f.value.id,{...ne.value,from_date:a,to_date:t,next_date:l,prev_date:e});se.value=o.dates.map(z=>s.timezonize(z)),o.count>3e3&&v.value!=="year"&&H.warning("This current date range has more than 3000 records. Some records may not be displayed. To get complete records, contact support")}catch(o){se.value=[],H.error(`${ee("msg.error.fetchingActiveDates")} ${await W(o)}`),console.log(o)}},Je=async e=>{fe("c:calendar:change-calendar-view",e);try{v.value=e,q("calendarViewUpdate")&&await _e({meta:{...typeof T.value.meta=="string"?JSON.parse(T.value.meta):T.value.meta,active_view:e}}),v.value==="week"&&(b.value=null)}catch(a){H.error("Error changing calendar view"),console.log(a)}},Ce=V(()=>Ve.value&&h.value.some(e=>{var a;return!!((a=e.fk_from_col)!=null&&a.readonly)}));async function Ne(){var e,a,t,l;if(!(!((e=f==null?void 0:f.value)!=null&&e.id)||!((a=n==null?void 0:n.value)!=null&&a.columns))){re.value=!0;try{const u=R.value?(t=Ae.value)==null?void 0:t.view:await ue.dbView.calendarRead(f.value.id);T.value=u;const i=typeof u.meta=="string"?JSON.parse(u.meta):u.meta;v.value=i==null?void 0:i.active_view,v.value||(v.value="month"),h.value=(l=u==null?void 0:u.calendar_range)==null?void 0:l.map(m=>{var D,k,o,z,M,S,he,Oe;const d=(k=(D=n.value)==null?void 0:D.columns)==null?void 0:k.find(P=>P.id===m.fk_from_column_id),c=m.fk_to_column_id?(z=(o=n.value)==null?void 0:o.columns)==null?void 0:z.find(P=>P.id===m.fk_to_column_id):null;if((d==null?void 0:d.uidt)===J.Formula||(c==null?void 0:c.uidt)===J.Formula){const P=(d==null?void 0:d.uidt)===J.Formula&&((S=(M=d==null?void 0:d.colOptions)==null?void 0:M.parsed_tree)==null?void 0:S.dataType)===be.DATE,Ze=(c==null?void 0:c.uidt)===J.Formula&&((Oe=(he=c==null?void 0:c.colOptions)==null?void 0:he.parsed_tree)==null?void 0:Oe.dataType)===be.DATE;if(!P)return H.error(`Please update the Formula column ${d==null?void 0:d.title} to return a date`),null;if(c&&!Ze)return H.error(`Please update the Formula column ${c==null?void 0:c.title} to return a date`),null}return{id:m==null?void 0:m.id,fk_from_col:d,fk_to_col:c,is_readonly:[d,c].some(P=>ta(P)||la(P))}}).filter(Boolean)}catch(u){H.error(`Error loading calendar meta ${await W(u)}`)}finally{re.value=!1}}}async function x(e=!0){var i,m,d,c,D;if((!((i=p==null?void 0:p.value)!=null&&i.id)||!((m=n.value)!=null&&m.id)||!((d=f.value)!=null&&d.id))&&!(R!=null&&R.value)||!((c=h.value)!=null&&c.length)||v.value==="year")return;let a=null,t=null,l=null,u=null;switch(v.value){case"day":a=r.value.subtract(1,"day").endOf("day"),u=r.value.add(1,"day").startOf("day"),t=r.value.startOf("day"),l=r.value.endOf("day");break;case"week":t=_.value.start.startOf("week"),l=_.value.end.endOf("week"),a=s.timezonize(t.subtract(1,"day")).endOf("day"),u=s.timezonize(l.add(1,"day")).startOf("day"),(D=oe.value)!=null&&D.hide_weekend&&(l=s.timezonize(l.subtract(2,"day")).endOf("day"),u=s.timezonize(u.subtract(2,"day")).startOf("day"));break;case"month":{const k=s.timezonize(g.value.startOf("month")),o=s.timezonize(k.startOf("week")),z=s.timezonize(g.value.endOf("month")).endOf("week");t=o,l=z,a=t.subtract(1,"day").endOf("day"),u=l.add(1,"day").startOf("day");break}}a=s.dayjsTz(a).format("YYYY-MM-DD HH:mm:ssZ"),u=s.dayjsTz(u).format("YYYY-MM-DD HH:mm:ssZ"),t=s.dayjsTz(t).format("YYYY-MM-DD HH:mm:ssZ"),l=s.dayjsTz(l).format("YYYY-MM-DD HH:mm:ssZ");try{e&&(le.value=!0);const k=R.value?await Me({sortsArr:ae.value,prev_date:a,next_date:u,to_date:l,from_date:t,filtersArr:E.value}):await K.dbCalendarViewRow.list("noco",p.value.id,n.value.id,f.value.id,{prev_date:a,next_date:u,to_date:l,from_date:t,include_row_color:!0},{...ne.value,...q("filterSync")?{filterArrJson:[]}:{filterArrJson:JSON.stringify([E.value])},where:(C==null?void 0:C.value)??"",filterArrJson:JSON.stringify([...E.value])});G.value=ce(k.list,Z)}catch(k){H.error(`${ee("msg.error.fetchingCalendarData")} ${await W(k)}`),console.log(k)}finally{le.value=!1}}async function _e(e){var t;if(!((t=f==null?void 0:f.value)!=null&&t.id)||!q("viewCreateOrEdit",{skipSourceCheck:!0})||R.value)return;const a={...typeof T.value.meta=="string"?JSON.parse(T.value.meta):T.value.meta,...typeof e.meta=="string"?JSON.parse(e.meta):e.meta};try{await ue.dbView.calendarUpdate(f.value.id,{...e,meta:JSON.stringify(a)}),T.value={...T.value,...e,meta:a}}catch(l){H.error("Error updating changes"),console.log(l)}}function we(e){var t;const a=ia(e,(t=n==null?void 0:n.value)==null?void 0:t.columns);for(const l of G.value)if(Object.keys(a).every(u=>a[u]===l.row[u]))return l}const $e=async e=>{switch(v.value){case"month":g.value=e==="next"?g.value.add(1,"month"):g.value.subtract(1,"month"),y.value=e==="next"?y.value.add(1,"month"):y.value.subtract(1,"month"),y.value.year()!==r.value.year()&&(y.value=r.value);break;case"year":r.value=e==="next"?r.value.add(1,"year"):r.value.subtract(1,"year"),y.value.year()!==r.value.year()&&(y.value=r.value);break;case"day":r.value=e==="next"?r.value.add(1,"day"):r.value.subtract(1,"day"),b.value=r.value,(y.value.year()!==r.value.year()||y.value.month()!==r.value.month())&&(y.value=r.value);break;case"week":_.value=e==="next"?{start:_.value.start.add(7,"day"),end:_.value.end.add(7,"day")}:{start:_.value.start.subtract(7,"day"),end:_.value.end.subtract(7,"day")},y.value.month()!==_.value.end.month()&&(y.value=_.value.start);break}},Y=async(e=!0)=>{var a,t,l,u;if(!(!((a=p==null?void 0:p.value)!=null&&a.id)||!((t=n.value)!=null&&t.id)||!((l=f.value)!=null&&l.id)||!((u=h.value)!=null&&u.length)))try{e&&(X.value=!0);const i=R.value?await ye({sortsArr:ae.value,filtersArr:[...E.value,...L.value]}):await K.dbViewRow.list("noco",p.value.id,n.value.id,f.value.id,{...ne.value,filterArrJson:JSON.stringify([...L.value]),include_row_color:!0});F.value=ce(i.list,Z)}catch(i){H.error(`${ee("msg.error.fetchingCalendarData")} ${await W(i)}`),console.log(i)}finally{X.value=!1}};async function ie(e,a,t=!1){var l,u,i,m;try{const d=de(e.row,(l=n==null?void 0:n.value)==null?void 0:l.columns),c=a.reduce((o,z)=>(o[z]=e.row[z],o),{}),D=await ue.dbViewRow.update(ra,p==null?void 0:p.value.id,(u=n.value)==null?void 0:u.id,(i=f==null?void 0:f.value)==null?void 0:i.id,encodeURIComponent(d),c);t||(Re({redo:{fn:async(o,z)=>{const M=await ie(o,z,!0),S=we(o.row);S&&Object.assign(S.row,M),Object.assign(S==null?void 0:S.oldRow,M)},args:[me(e),a]},undo:{fn:async(o,z)=>{const M=await ie({row:o.oldRow,oldRow:o.row,rowMeta:o.rowMeta},z,!0),S=we(o.row);S&&Object.assign(S.row,M),Object.assign(S.oldRow,M)},args:[me(e),a]},scope:He({view:f.value})}),Object.assign(e.row,D),Object.assign(e.oldRow,D));const k=de(D,(m=n==null?void 0:n.value)==null?void 0:m.columns);return F.value=F.value.map(o=>{var z;return de(o.row,(z=n==null?void 0:n.value)==null?void 0:z.columns)===k&&(Object.assign(o.row,D),Object.assign(o.oldRow,D)),Object.assign(o.rowMeta,Z(o.row)),o}),await A(),D}catch(d){H.error(`${ee("msg.error.rowUpdateFailed")}: ${await W(d)}`)}}return j(r,async(e,a)=>{v.value==="month"||v.value==="week"?O.value==="selectedDate"&&$.value&&await Y():v.value==="year"?e.year()!==a.year()?await Promise.all([x(),Y(),await A()]):O.value==="selectedDate"&&$.value&&await Y():$.value?await Promise.all([Y(),x()]):await Promise.all([x()]),v.value==="year"&&e.year()!==a.year()&&await A()}),j(b,async()=>{U.value!==J.Date&&$.value&&O.value==="selectedHours"&&await Y()}),j(g,async()=>{v.value==="month"&&await Promise.all([x(),Y(),A()])}),j(_,async()=>{v.value==="week"&&await Promise.all([x(),Y()])}),j(v,async(e,a)=>{a==="week"?(y.value=r.value,g.value=r.value??_.value.start,r.value=r.value??_.value.start,b.value=r.value??_.value.start):a==="month"?(y.value=r.value,b.value=r.value,_.value={start:r.value.startOf("week"),end:r.value.endOf("week")}):a==="day"?(y.value=r.value,b.value=r.value,g.value=r.value,_.value={start:r.value.startOf("week"),end:r.value.endOf("week")}):a==="year"&&(g.value=r.value,b.value=r.value,y.value=r.value,_.value={start:r.value.startOf("week"),end:r.value.endOf("week")}),O.value=v.value??"allRecords",v.value==="year"?await Promise.all([Y(),A()]):await Promise.all([x(),Y(),A()])}),j($,async e=>{e&&await Y()}),j(O,async()=>{fe("a:calendar:sidebar-filter",O.value),await Y()}),j([()=>N.value,()=>{var e;return(e=I.value)==null?void 0:e.id}],async()=>{await Y()}),j(y,async()=>{v.value!=="year"&&await A()}),j([B,U],([e,a])=>{const t=ge(!0,a===J.Date?null:e);s.dayjsTz=t.dayjsTz,s.timezonize=t.timezonize,y.value=s.timezonize(y.value),r.value=s.timezonize(r.value),b.value=s.timezonize(b.value),g.value=s.timezonize(g.value),_.value={start:r.value.startOf("week"),end:r.value.endOf("week")}}),j(()=>oe.value.hide_weekend,async()=>{v.value==="week"&&await x()}),Fe.on(e=>{[Ye.TRIGGER_RE_RENDER,Ye.ON_ROW_COLOUR_INFO_UPDATE].includes(e)&&(G.value=G.value.map(a=>(Object.assign(a.rowMeta,Z(a.row)),a)),F.value=F.value.map(a=>(Object.assign(a.rowMeta,Z(a.row)),a)))}),{fetchActiveDates:A,formattedSideBarData:F,loadMoreSidebarData:Ee,updateCalendarMeta:_e,loadSidebarData:Y,displayField:I,sideBarFilterOption:O,searchQuery:N,activeDates:se,isCalendarDataLoading:le,isCalendarMetaLoading:re,changeCalendarView:Je,calDataType:U,loadCalendarMeta:Ne,calendarRange:h,loadCalendarData:x,formattedData:G,isSidebarLoading:X,showSideMenu:$,selectedTime:b,calendarMetaData:T,updateRowProperty:ie,activeCalendarView:v,pageDate:y,paginationData:pe,selectedDate:r,selectedMonth:g,selectedDateRange:_,paginateCalendarView:$e,viewMetaProperties:oe,updateFormat:Pe,timezoneDayjs:s,timezone:B,isSyncedFromColumn:Ce}});function _a(){const n=da();if(n==null)throw new Error("Please call `useProvideCalendarViewStore` on the appropriate parent component");return n}export{_a as a,pa as u};
