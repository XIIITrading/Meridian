import{r as P,J as B,as as D,f as G,a7 as L,a8 as I,n as w,L as b,ep as N,lh as Z,a4 as _,a5 as f,dG as i,e as H,I as J,o as K,M as q}from"./DOFFjK0_.js";import{u as z}from"./SJHyi9T4.js";import{e as R}from"./D2QgEzTv.js";import{i as Q,a as X,b as Y,c as ee,d as ae,e as te,f as se,h as re}from"./Bo7kLdUR.js";const[ve,ne]=z((o,t)=>{const v=P(!1),{user:T}=B(),{isUIAllowed:y}=D(),{$e:C,$state:m,$api:p}=G(),V=L(),{basesUser:$}=I(V),h=w(()=>o.value.base_id?$.value.get(o.value.base_id)||[]:[]),r=P([]),E=w(()=>r.value.reduce((n,a)=>{if(a.id){let e=b(a.comment);if(a.updated_at!==a.created_at&&a.updated_at){const s=N(a.updated_at).replace(" ","_");e+=` [(edited)](a~~~###~~~Edited_${s}) `}n[a.id]=Z.parse(e,{enableMention:!1,users:b(h.value),currentUser:b(T.value)},!0)??""}return n},{})),x=async(n,a=!0)=>{if(!y("commentList")||!t.value&&!n)return;const e=n??R(t.value.row,o.value.columns);if(e)try{a||(v.value=!0);const s=(await p.utils.commentList({row_id:e,fk_model_id:o.value.id})).list||[];r.value=s.map(u=>{const l=h.value.find(d=>d.id===u.created_by),c=u.resolved_by?h.value.find(d=>d.id===u.resolved_by):null;return{...u,created_display_name:(l==null?void 0:l.display_name)??((l==null?void 0:l.email)??"").split("@")[0]??"",resolved_display_name:c?c.display_name??c.email.split("@")[0]:void 0,created_by_meta:l==null?void 0:l.meta,resolved_by_meta:c==null?void 0:c.meta}})}catch(s){_.error(await f(s))}finally{a||(v.value=!1)}},O=async n=>{if(!y("commentDelete"))return;const a=r.value.find(e=>e.id===n);if(a)try{r.value=r.value.filter(e=>e.id!==n),await p.utils.commentDelete(n),Object.assign(t.value,{...t.value,rowMeta:{...t.value.rowMeta,commentCount:(t.value.rowMeta.commentCount??1)-1}})}catch(e){_.error(await f(e)),r.value=[...r.value,a]}},S=async n=>{if(!y("commentResolve"))return;const a=r.value.find(e=>e.id===n);if(a)try{r.value=r.value.map(e=>{var s,u,l,c,d,F,M,g,k,A;return e.id===n?{...e,resolved_by:a.resolved_by||(u=(s=m.user)==null?void 0:s.value)==null?void 0:u.id,resolved_by_email:a.resolved_by||(c=(l=m.user)==null?void 0:l.value)==null?void 0:c.email,resolved_display_name:a.resolved_by?void 0:((F=(d=m.user)==null?void 0:d.value)==null?void 0:F.display_name)??((g=(M=m.user)==null?void 0:M.value)==null?void 0:g.email.split("@")[0]),resolved_by_meta:a.resolved_by||(A=(k=m.user)==null?void 0:k.value)==null?void 0:A.meta}:e}),await p.utils.commentResolve(n,{})}catch(e){r.value=r.value.map(s=>s.id===n?a:s),_.error(await f(e))}},U=async n=>{var a;try{if(!t.value||!n){r.value=r.value.filter(s=>{var u;return!((u=s.id)!=null&&u.startsWith("temp-"))});return}const e=R(t.value.row,o.value.columns);if(!e)return;await p.utils.commentRow({fk_model_id:(a=o.value)==null?void 0:a.id,row_id:e,comment:`${n}`.replace(/(<br \/>)+$/g,"")}),Object.assign(t.value,{rowMeta:{...t.value.rowMeta,commentCount:(t.value.rowMeta.commentCount??0)+1}}),await x()}catch(e){r.value=r.value.filter(s=>!(s.id??"").startsWith("temp-")),_.error(await f(e))}C("a:row-expand:comment")},j=async(n,a)=>{const e=r.value.find(s=>s.id===n);if(e)try{r.value=r.value.map(s=>s.id===n?{...s,...a,updated_at:new Date().toISOString()}:s),await p.utils.commentUpdate(n,a)}catch(s){r.value=r.value.map(u=>u.id===n?e:u),_.error(await f(s))}},W=w(()=>R(t.value.row,o.value.columns));return{comments:r,loadComments:x,saveComment:U,updateComment:j,resolveComment:S,deleteComment:O,isCommentsLoading:v,primaryKey:W,parsedHtmlComments:E}});function me(){const o=ne();if(!o)throw new Error("useRowComments is not provided");return o}const oe=(o,t)=>w(()=>Q(i(o)||"",i(t))?"ncFileTypeImage":X(i(o)||"",i(t))?"ncFileTypePdf":Y(i(o)||"",i(t))?"ncFileTypeVideo":ee(i(o)||"",i(t))?"ncFileTypeAudio":ae(i(o)||"",i(t))?"ncFileTypeWord":te(i(o)||"",i(t))?"ncFileTypeCsv":se(i(o)||"",i(t))?"ncFileTypePresentation":re(i(o)||"",i(t))?"ncFileTypeZip":"ncFileTypeUnknown"),ie=H({__name:"IconView",props:{item:{}},setup(o){const t=o,v=oe(()=>t.item.title,t.item.mimetype);return(T,y)=>{const C=q;return K(),J(C,{icon:b(v),class:"text-white"},null,8,["icon"])}}}),pe=Object.assign(ie,{__name:"CellAttachmentIconView"});export{pe as _,me as a,ve as u};
