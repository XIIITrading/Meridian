import{e as oe,f as ne,S as ie,G as N,r as m,aZ as ce,aY as de,fT as ue,j9 as re,n as J,T as pe,aQ as me,a_ as _e,aC as ve,aD as fe,g as ge,I as h,o as _,w as u,a as n,d as r,aT as T,L as a,b9 as B,t as d,b as v,ar as xe,P as U,O as he,ag as ke,c as P,N as be,j as ye,ap as we,bY as Ce,aJ as Me,Q as $e,f$ as je,g0 as Le,f_ as Ne,aj as Te,gR as Ie,a4 as Ae,_ as Ve}from"./DOFFjK0_.js";import{D as ze}from"./BhfICdUA.js";import"./NRjd0XWG.js";const Oe={class:"flex flex-col gap-3"},Be={class:"text-base text-gray-800 font-semibold"},Ue={class:"text-gray-500 text-[13px] leading-5"},Fe={class:"font-semibold"},De={class:"flex w-full gap-2 justify-between items-center"},Se={class:"flex items-center gap-2"},Ee=["data-testid","onClick"],He={class:"flex flex-row items-center w-full cursor-pointer truncate ml-1 py-[5px] pr-2"},Re={key:1},Ge={class:"flex w-full gap-2 justify-end"},Qe=oe({__name:"AddLookups",props:{value:{type:Boolean}},setup(Z){const K=Z,{$api:W}=ne(),{getMeta:F,metas:D}=ie(),p=N(ce,m()),S=N(de,m()),I=N(ue),A=N(re),E=J(()=>(I==null?void 0:I.value)||(A==null?void 0:A.value)),k=pe(K,"value"),V=m(!1),b=m(""),x=m([]),i=m({}),X=e=>ye(Ne(e)?je:Le,{columnMeta:e}),H=m(!1),ee=J(()=>{var e;return(e=E.value.colOptions)==null?void 0:e.fk_related_model_id}),o=m(),ae=()=>{Object.keys(i.value).forEach(e=>i.value[e]=!1)},te=()=>{x.value.forEach(e=>i.value[e.id]=!0)},le=async()=>{var e,l,c,f,C,M,$,j,g,y,t,w,R,G;try{V.value=!0;const L=[],Q=((l=(e=p.value)==null?void 0:e.columns)==null?void 0:l.length)??0;for(const[z]of Object.entries(i.value).filter(([,s])=>s)){const s=D.value[(c=o.value)==null?void 0:c.id].columns.find(O=>O.id===z),Y=x.value.findIndex(O=>O.id===z),q={uidt:Te.Lookup,fk_lookup_column_id:z,fk_relation_column_id:E.value.id,lookupTableTitle:(f=o.value)==null?void 0:f.title,lookupColumnTitle:(s==null?void 0:s.title)||s.column_name,table_name:(C=p.value)==null?void 0:C.table_name,title:`${s==null?void 0:s.title} from ${(M=o.value)==null?void 0:M.title}`,view_id:($=S.value)==null?void 0:$.id,order:Q+Y,column_name:`${s==null?void 0:s.title} from (${(j=o.value)==null?void 0:j.title})`,column_order:{order:Q+Y,view_id:(g=S.value)==null?void 0:g.id}},se=Ie({formState:q,metaColumns:(y=o.value)==null?void 0:y.columns,tableExplorerColumns:(t=p.value)==null?void 0:t.columns});L.push({op:"add",column:{...q,title:se}})}await W.dbTableColumn.bulk((w=p.value)==null?void 0:w.id,{hash:(R=p.value)==null?void 0:R.columnsHash,ops:L}),await F((G=p==null?void 0:p.value)==null?void 0:G.id,!0),k.value=!1}catch(L){console.error(L),Ae.error("Failed to create lookup columns")}finally{V.value=!1}};return me([o,b],async()=>{var e;if(o.value){const l=((e=D.value[o.value.id])==null?void 0:e.columns)||[];x.value=l.filter(c=>!ve(c)&&!fe(c)&&_e([c==null?void 0:c.title],b.value))}}),ge(async()=>{o.value=await F(ee.value)}),(e,l)=>{const c=xe,f=he,C=we,M=Ce,$=Me,j=$e;return _(),h(j,{visible:a(k),"onUpdate:visible":l[3]||(l[3]=g=>U(k)?k.value=g:null),size:"small"},{default:u(()=>{var g,y;return[n("div",Oe,[n("div",null,[n("h1",Be,[(_(),h(T(("iconMap"in e?e.iconMap:a(B)).cellLookup),{class:"text-gray-500 pb-1"})),r(" "+d(e.$t("general.addLookupField")),1)]),n("div",Ue,[r(d(e.$t("labels.addNewLookupHelperText1"))+" ",1),n("span",Fe,d(((g=a(o))==null?void 0:g.title)??((y=a(o))==null?void 0:y.table_name)),1),r(" "+d(e.$t("labels.addNewLookupHelperText2")),1)])]),n("div",De,[v(c,{value:a(b),"onUpdate:value":l[0]||(l[0]=t=>U(b)?b.value=t:null),class:"w-full h-8 flex-1",size:"small",placeholder:e.$t("placeholder.searchFields")},{prefix:u(()=>[(_(),h(T(("iconMap"in e?e.iconMap:a(B)).search),{class:"w-4 text-gray-500 h-4"}))]),_:1},8,["value","placeholder"]),n("div",Se,[v(f,{size:"small",type:"text",class:"!text-xs",onClick:ae},{default:u(()=>[r(d(e.$t("labels.clearAll")),1)]),_:1}),v(f,{size:"small",type:"text",class:"!text-xs",onClick:te},{default:u(()=>[r(d(e.$t("general.addAll")),1)]),_:1})])]),n("div",{class:ke([{"flex items-center justify-center":a(H)},"border-1 rounded-md h-[300px] nc-scrollbar-md border-gray-200"])},[a(H)?(_(),P("div",Re,[v($,{size:"xlarge"})])):(_(),h(a(ze),{key:0,modelValue:a(x),"onUpdate:modelValue":l[1]||(l[1]=t=>U(x)?x.value=t:null),"item-key":"id","ghost-class":"nc-lookup-menu-items-ghost"},{item:u(({element:t})=>[(_(),P("div",{key:t.id,"data-testid":`nc-lookup-add-menu-${t.title}`,class:"px-3 py-1 flex flex-row items-center rounded-md hover:bg-gray-100",onClick:be(w=>a(i)[t.id]=!a(i)[t.id],["stop"])},[(_(),h(T(("iconMap"in e?e.iconMap:a(B)).drag),{class:"cursor-move !h-3.75 text-gray-600 mr-1"})),n("div",He,[(_(),h(T(X(t)),{class:"!w-3.5 !h-3.5 !text-gray-500"})),v(C,{class:"flex-1 pl-1 pr-2 truncate","show-on-truncate-only":""},{title:u(()=>[r(d(t.title),1)]),default:u(()=>[r(d(t.title),1)]),_:2},1024),v(M,{checked:a(i)[t.id],"onUpdate:checked":w=>a(i)[t.id]=w,size:"default"},null,8,["checked","onUpdate:checked"])]),l[4]||(l[4]=n("div",{class:"flex-1"},null,-1))],8,Ee))]),_:1},8,["modelValue"]))],2),n("div",Ge,[v(f,{type:"secondary",size:"small",onClick:l[2]||(l[2]=t=>k.value=!1)},{default:u(()=>[r(d(e.$t("general.cancel")),1)]),_:1}),v(f,{loading:a(V),disabled:!Object.values(a(i)).filter(Boolean).length,size:"small",onClick:le},{default:u(()=>[r(d(e.$t("general.addLookupField",{count:Object.values(a(i)).filter(Boolean).length||""})),1)]),_:1},8,["loading","disabled"])])])]}),_:1},8,["visible"])}}}),Pe=Object.assign(Ve(Qe,[["__scopeId","data-v-826f5377"]]),{__name:"SmartsheetHeaderAddLookups"});export{Pe as default};
