import{b as X}from"./C44sDnaa.js";import{e as Y,f as P,V as Z,a8 as ee,a9 as te,r as d,g as ae,ac as se,c as _,o as n,a as l,I as g,ad as R,L as c,w as m,d as p,aT as E,b9 as V,t as y,at as ne,b as v,ag as N,O as oe,K as L,ap as le,ai as G,a4 as O,a5 as ie}from"./DOFFjK0_.js";import{_ as ce}from"./sgaWLnOz.js";import{_ as ue}from"./BRY4OykS.js";import{_ as me}from"./BrfakvRE.js";import"./KFthsW2H.js";import"./Db9kSA7A.js";import"./Bo7kLdUR.js";import"./lL-0_K96.js";import"./JVTgKN82.js";import"./HdsRe6lq.js";import"./4fFkR2QG.js";const fe={class:"h-full flex flex-col w-full"},re={class:"h-full flex flex-col"},de={class:"flex flex-row justify-between items-center w-full mb-4"},_e={class:"flex"},pe={key:0},ye={class:"flex items-center gap-2"},ve={key:1},ge={class:"flex items-center gap-2 text-gray-600 font-light"},he={key:0,class:"flex flex-col justify-center items-center h-full overflow-y-auto"},be={class:"flex justify-center"},xe={key:0,class:"flex items-center gap-2 max-w-full"},we={class:"min-w-5 flex items-center justify-center"},ke={key:1,class:"flex items-center gap-2 max-w-full"},Se=Y({__name:"Metadata",props:{sourceId:{}},emits:["baseSynced"],setup(z,{emit:A}){const $=z,F=A,{$api:j}=P(),B=Z(),{loadTables:W}=B,{base:h}=ee(B),{t:C}=te(),b=d(),f=d(!1),x=d(!1),w=d(!1),r=d(!1),k=d([]);async function D(e=!1){var a,i,s;try{if(!((a=h.value)!=null&&a.id)||w.value&&!r.value&&!e)return;f.value=!0,x.value=!1,k.value=await j.source.metaDiffGet((i=h.value)==null?void 0:i.id,$.sourceId);for(const o of k.value)((s=o.detectedChanges)==null?void 0:s.length)>0&&(o.syncState=o.detectedChanges.map(u=>u==null?void 0:u.msg).join(", "),x.value=!0)}catch(o){console.error(o)}finally{f.value=!1,e&&(r.value=!0)}}const{$poller:J}=P(),K=()=>{w.value=!1,r.value=!1};async function q(){var e,a;try{if(!((e=h.value)!=null&&e.id)||!x.value)return;f.value=!0,w.value=!0;const i=await j.source.metaDiffSync((a=h.value)==null?void 0:a.id,$.sourceId);J.subscribe({id:i.id},async s=>{var o,u,S;s.status!=="close"&&(s.status===G.COMPLETED?(O.info(C("msg.info.metaDataRecreated")),b.value.pushProgress("Done!",s.status),f.value=!1,await W(),await D(!0),F("baseSynced")):s.status===G.FAILED?(b.value.pushProgress(((u=(o=s.data)==null?void 0:o.error)==null?void 0:u.message)||"Failed to sync base metadata",s.status),r.value=!0,f.value=!1):b.value.pushProgress((S=s.data)==null?void 0:S.message))})}catch(i){O.error(await ie(i))}}ae(async()=>{k.value.length===0&&await D()});const H=[{title:C("labels.models"),key:"table_name",name:"table_name",minWidth:200,padding:"0px 12px"},{title:C("labels.syncState"),dataIndex:"syncState",key:"syncState",minWidth:200,padding:"0px 12px"}],Q=e=>({class:`nc-metasync-row nc-metasync-row-${e.table_name}`});return(e,a)=>{const i=ne,s=me,o=X,u=oe,S=ce,I=le,U=ue,T=se("e");return n(),_("div",fe,[l("div",re,[l("div",de,[l("div",_e,[c(x)?(n(),_("div",pe,[R((n(),g(i,{class:"nc-btn-metasync-sync-now",type:"primary",onClick:q},{default:m(()=>[l("div",ye,[(n(),g(E(("iconMap"in e?e.iconMap:c(V)).databaseSync))),p(" "+y(e.$t("activity.metaSync")),1)])]),_:1})),[[T,["a:proj-meta:meta-data:sync"]]])])):(n(),_("div",ve,[l("span",null,[v(s,{message:e.$t("msg.info.tablesMetadataInSync"),type:"success","show-icon":"",class:"!rounded-md"},null,8,["message"])])]))]),R((n(),g(i,{class:"self-start !rounded-md nc-btn-metasync-reload",onClick:a[0]||(a[0]=M=>D())},{default:m(()=>[l("div",ge,[(n(),g(E(("iconMap"in e?e.iconMap:c(V)).reload),{class:N({"animate-infinite animate-spin !text-success":c(f)})},null,8,["class"])),p(" "+y(e.$t("general.reload")),1)])]),_:1})),[[T,["a:proj-meta:meta-data:reload"]]])]),c(w)?(n(),_("div",he,[v(o,{ref_key:"progressRef",ref:b,class:"w-1/2 h-full"},null,512),l("div",be,[v(u,{"html-type":"submit",class:N(["mt-4 mb-8",{"sync-completed":c(r)}]),size:"medium",disabled:!c(r),onClick:K},{default:m(()=>a[1]||(a[1]=[p(" Back ")])),_:1,__:[1]},8,["class","disabled"])])])):(n(),g(U,{key:1,columns:H,data:c(k)??[],"row-height":"44px","header-row-height":"44px","is-data-loading":c(f),"custom-row":Q,class:"nc-metasync-table h-[calc(100%_-_58px)] w-full"},{bodyCell:m(({column:M,record:t})=>[M.key==="table_name"?(n(),_("div",xe,[l("div",we,[v(S,{meta:t,class:"text-gray-500"},null,8,["meta"])]),v(I,{class:"truncate","show-on-truncate-only":""},{title:m(()=>[p(y(t.title||t.table_name),1)]),default:m(()=>[p(" "+y(t.title||t.table_name),1)]),_:2},1024)])):L("",!0),M.key==="syncState"?(n(),_("div",ke,[v(I,{class:"truncate","show-on-truncate-only":""},{title:m(()=>[p(y((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),1)]),default:m(()=>[l("span",{class:N({"text-red-500":t==null?void 0:t.syncState,"text-gray-500":!(t!=null&&t.syncState)})},y((t==null?void 0:t.syncState)||e.$t("msg.info.metaNoChange")),3)]),_:2},1024)])):L("",!0)]),_:1},8,["data","is-data-loading"]))]),a[2]||(a[2]=l("div",{class:"flex place-content-center item-center"},null,-1))])}}}),Ve=Object.assign(Se,{__name:"DashboardSettingsMetadata"});export{Ve as default};
