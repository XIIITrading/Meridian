import{_ as ge}from"./BAEjtfOx.js";import{e as we,J as ye,G as o,fT as ke,gb as be,r as i,kX as Ce,kr as _e,em as xe,n as f,gC as he,gy as Ie,cd as Se,k9 as Oe,kY as Ee,f as je,as as Me,V as Te,aQ as Q,bx as $e,gJ as Z,a4 as Ke,a5 as Ve,bv as Ne,Y as Pe,iC as Le,ko as Be,j7 as Fe,gD as De,jd as qe,g as Re,i_ as Ae,kZ as Ge,c as j,o as m,I as M,L as a,b0 as Ue,b as N,K as H,P as W,t as S,w as _,an as ze,aq as Je,eO as Xe,N as ee,ag as O,bX as Ye,a as E,cn as Qe,ig as Ze,ap as He,d as ae,aT as We,b9 as ea,bB as aa,a3 as la,_ as ta}from"./DOFFjK0_.js";import{g as sa}from"./Cb5B9eG-.js";import{u as na}from"./CV-2bRRD.js";import"./D4c215jk.js";const oa=["onKeydown"],ia={key:0,class:"w-full max-w-full"},ua={class:"text-ellipsis overflow-hidden",style:{wordBreak:"keep-all",whiteSpace:"nowrap",display:"inline"}},ra={class:"flex gap-2 text-gray-500 items-center h-full"},ca={class:"text-xs whitespace-normal"},da=we({__name:"Editor",props:{modelValue:{},rowIndex:{},disableOptionCreation:{type:Boolean},options:{}},emits:["update:modelValue"],setup(T,{emit:le}){const te=le,{isMobileMode:P}=ye(),u=o(ke),x=o(be),L=o(Ce,i(!1)),B=o(_e,i(!1)),g=o(xe,i(!1)),w=f(()=>B.value||L.value||g.value),k=i(),t=i(!1),F=o(he,null),D=o(Ie,i(!1)),q=o(Se,i(!1)),$=o(Oe,i(!1)),se=o(Ee,i(!1)),{$api:ne}=je(),d=i(),{isUIAllowed:R,isMetaReadOnly:oe}=Me(),{isPg:A,isMysql:ie}=Te(),h=i(),K=i(!1),G=f(()=>!q.value&&!T.disableOptionCreation&&R("fieldEdit")&&!oe.value&&!g.value),y=f(()=>T.options??sa(u.value,$.value,g.value)),U=f(()=>y.value.reduce((e,l)=>(l.value&&(e[l.value.trim()]=l),e),{})),ue=f(()=>d.value?!U.value[d.value]:!1),V=f(()=>R("dataEdit")||g.value),v=f(()=>(V.value||g.value)&&w.value),r=f({get:()=>h.value??T.modelValue,set:e=>{if(e&&G.value&&(y.value??[]).every(l=>l.title!==e))return h.value=e,re();te("update:modelValue",e||null)}});Q(t,(e,l)=>{var c,s,b,p,C,I;v.value&&(e?(I=(C=(p=k.value)==null?void 0:p.$el)==null?void 0:C.querySelector("input"))==null||I.focus():(b=(s=(c=k.value)==null?void 0:c.$el)==null?void 0:s.querySelector("input"))==null||b.blur())}),na(B,e=>{var l;switch(e.key){case"Escape":if(F){F.trigger();return}t.value=!1;break;case"Enter":v.value&&w.value&&!t.value&&(t.value=!0);break;case" ":break;default:if(!v.value){e.preventDefault();break}!(e.metaKey||e.ctrlKey||e.altKey)&&((l=e.key)==null?void 0:l.length)===1&&!$e()&&(e.stopPropagation(),t.value=!0);break}},{immediate:!0,isGridCell:!0});async function re(){var l,c;if(!h.value||q.value)return!1;const e=h.value;if(d.value="",h.value=void 0,e&&!U.value[e])try{y.value.push({title:e,value:e,color:Z.light[(y.value.length+1)%Z.light.length]}),u.value.colOptions={options:y.value.map(({value:p,...C})=>C)};const s={...u.value};s.cdf&&(A(u.value.source_id)&&(s.cdf=s.cdf.substring(s.cdf.indexOf("'")+1,s.cdf.lastIndexOf("'"))),!ie(u.value.source_id)&&!A(u.value.source_id)&&(s.cdf=s.cdf.replace(/''/g,"'")));const b=await ne.dbTableColumn.update(((l=u.value)==null?void 0:l.fk_column_id)||((c=u.value)==null?void 0:c.id),s);u.value.colOptions=b.columns.find(p=>p.id===u.value.id).colOptions,r.value=e}catch(s){console.log(s),Ke.error(await Ve(s))}}const ce=()=>{var e,l,c;P.value||(d.value=(c=(l=(e=k.value)==null?void 0:e.$el)==null?void 0:l.querySelector(".ant-select-selection-search-input"))==null?void 0:c.value)},de=e=>{t.value&&w.value&&e.stopPropagation(),e.key==="Enter"&&e.stopPropagation(),e.key==="Escape"&&(t.value=!1)},ve=()=>{t.value=!1,L.value=!1},z=e=>{var l,c;if((l=e.target)!=null&&l.classList.contains("ant-select-clear")||(c=e.target)!=null&&c.closest(".ant-select-clear"))return r.value="",e.stopPropagation();K.value||(t.value=v.value&&!t.value)};Ne(document,"click",e=>{t.value&&k.value&&!k.value.$el.contains(e.target)&&(t.value=!1)},!0);const J=()=>{K.value=!0,setTimeout(()=>{K.value=!1},250),!(se.value&&r.value)&&(t.value=!0)};Q(()=>w.value,e=>{e||(d.value="",t.value=!1)});const pe=o(Le,Pe({})),fe=o(Be,i(!1)),me=o(Fe,!1),X=o(De,i(!1)),Y=o(qe,i(!1));return Re(()=>{!fe.value&&me&&!X.value&&Y.value&&!$.value&&Ae(()=>{const e=pe.keyboardKey;e&&Ge(e)&&(d.value=e),J()})}),(e,l)=>{var I;const c=ge,s=He,b=Ye,p=Xe,C=aa;return m(),j("div",{class:O(["nc-cell-field h-full w-full flex items-center nc-single-select focus:outline-transparent",{"read-only":a(x),"max-w-full":a(g)}]),onClick:z,onKeydown:la(ee(z,["stop","prevent"]),["enter"])},[!a($)&&a(g)&&((I=("parseProp"in e?e.parseProp:a(Ue))(a(u).meta))!=null&&I.isList)?(m(),j("div",ia,[N(c,{modelValue:a(r),"onUpdate:modelValue":l[0]||(l[0]=n=>W(r)?r.value=n:null),options:a(y),disabled:a(x)||!a(v),"row-index":e.rowIndex},null,8,["modelValue","options","disabled","row-index"]),!a(x)&&a(v)&&a(r)?(m(),j("div",{key:0,class:"inline-block px-2 pt-2 cursor-pointer text-xs text-gray-500 hover:text-gray-800",onClick:l[1]||(l[1]=n=>r.value="")},S(e.$t("labels.clearSelection")),1)):H("",!0)])):(m(),M(C,{key:1,ref_key:"aselect",ref:k,value:a(r),"onUpdate:value":l[3]||(l[3]=n=>W(r)?r.value=n:null),class:O(["w-full overflow-hidden",{"caret-transparent":!a(V)}]),"allow-clear":!a(u).rqd&&a(v),bordered:!1,open:a(t)&&a(v),disabled:a(x)||!a(v),"show-search":!a(P)&&a(t)&&a(w),"show-arrow":a(V)&&!a(x)&&a(w)&&(a(r)===null||a(r)===void 0)&&!a(d),"dropdown-class-name":`nc-dropdown-single-select-cell !min-w-156px ${a(t)&&a(w)?"active":""}`,"dropdown-match-select-width":!0,"search-value":a(d)??"",onSelect:ve,onKeydown:l[4]||(l[4]=n=>de(n)),onSearch:ce,onBlur:l[5]||(l[5]=n=>t.value=!1),onFocus:J},{default:_(()=>[(m(!0),j(ze,null,Je(a(y),n=>(m(),M(p,{key:n.title,value:n.title,class:O(["gap-2",`nc-select-option-${a(u).title}-${n.title}`]),"data-testid":`select-option-${a(u).title}-${e.rowIndex}`,onClick:l[2]||(l[2]=ee(()=>{},["stop"]))},{default:_(()=>[N(b,{class:O(["rounded-tag max-w-full",{"!h-[22px]":a(Y)&&!a(X)}]),color:n.color},{default:_(()=>[E("span",{style:Qe({color:("getSelectTypeOptionTextColor"in e?e.getSelectTypeOptionTextColor:a(Ze))(n.color)}),class:O({"text-sm":a(D),"text-small":!a(D)})},[N(s,{class:"truncate max-w-full","show-on-truncate-only":""},{title:_(()=>[ae(S(n.title),1)]),default:_(()=>[E("span",ua,S(n.title),1)]),_:2},1024)],6)]),_:2},1032,["color","class"])]),_:2},1032,["value","data-testid","class"]))),128)),a(d)&&a(ue)&&a(G)?(m(),M(p,{key:a(d),value:a(d)},{default:_(()=>[E("div",ra,[(m(),M(We(("iconMap"in e?e.iconMap:a(ea)).plusThick),{class:"min-w-4"})),E("div",ca,[ae(S(e.$t("msg.selectOption.createNewOptionNamed"))+" ",1),E("strong",null,S(a(d)),1)])])]),_:1},8,["value"])):H("",!0)]),_:1},8,["value","class","allow-clear","open","disabled","show-search","show-arrow","dropdown-class-name","search-value"]))],42,oa)}}}),ya=Object.assign(ta(da,[["__scopeId","data-v-6bd8372d"]]),{__name:"CellSingleSelectEditor"});export{ya as default};
