import{e as D,mS as K,f as Q,n as R,aQ as P,I as H,o as h,L as n,w as m,a as k,c as A,K as U,ag as $,b as c,t as v,an as J,aq as ee,f$ as te,d as S,ap as oe,f_ as ne,g0 as se,_ as ae,r as le,es as ie,bh as re,aj as ce,fU as O,ak as de,dC as ue,ao as me,M as pe,by as fe,a1 as _e,P as ge,$ as he}from"./DOFFjK0_.js";import{_ as ye}from"./sgaWLnOz.js";import{_ as ve,l as we,d as j,a as be}from"./Dju0KrVl.js";import{u as X,P as V,a as B,i as G,b as F,M as xe,W as $e,R as W,G as ke,O as Te,c as Ce}from"./BlIUVhTI.js";const Ne={class:"capitalize"},Ae={key:0},Oe={key:1,class:"py-1 pr-0.5"},Se={class:"nc-erd-table-node-column flex items-center gap-2"},ze=D({__name:"TableNode",props:{data:{},showSkeleton:{type:Boolean},dragging:{type:Boolean}},setup(Y){const{viewport:z}=X(),_=K(!1,200),{$e:T}=Q(),L=t=>t.type==="mm"?t.fk_parent_column_id:t.fk_child_column_id,p=R(()=>Y.data.columns.length);return P(()=>z.value.zoom,()=>{_.value=!0}),(t,y)=>{const w=ye,g=te,b=oe,E=se,x=ve;return h(),H(x,{class:"h-full flex flex-1 justify-center items-center","modifier-key":t.showSkeleton||n(z).zoom>.35?"Alt":void 0,disabled:t.dragging||n(_)},{title:m(()=>[k("div",Ne,v(t.data.table),1)]),default:m(()=>[k("div",{class:$(["relative h-full max-w-76 flex flex-col justify-center bg-white min-w-16 min-h-8 rounded-lg nc-erd-table-node",[`nc-erd-table-node-${t.data.table}`,t.showSkeleton?"cursor-pointer items-center min-h-200px min-w-300px":""]]),onClick:y[0]||(y[0]=l=>n(T)("c:erd:node-click"))},[k("div",{class:$([[(t.showSkeleton,""),(n(p),"")],"text-gray-800 text-sm py-4 border-b-1 border-gray-200 rounded-t-lg w-full h-full px-3 font-medium flex items-center"])},[c(w,{class:$(["text-primary",{"!text-6xl !w-auto mr-2 !h-18":t.showSkeleton}]),meta:{meta:{}}},null,8,["class"]),k("div",{class:$([t.showSkeleton?"text-6xl":"","flex pr-2 pl-1"])},v(t.data.table),3)],2),t.showSkeleton?(h(),A("div",Ae,[c(n(B),{style:{left:"-20px"},class:"opacity-0",position:n(V).Left,type:"target",connectable:!1},null,8,["position"]),c(n(B),{style:{right:"-15px"},class:"opacity-0",position:n(V).Right,type:"source",connectable:!1},null,8,["position"])])):t.data.columns.length?(h(),A("div",Oe,[(h(!0),A(J,null,ee(t.data.columns,(l,M)=>{var C;return h(),A("div",{key:l.title},[k("div",{class:$(["relative w-full h-full flex items-center min-w-32 py-2 px-1",M+1===t.data.columns.length?"rounded-b-lg":""])},[l.relationType?(h(),A("div",{key:0,class:$(["flex w-full",`nc-erd-table-node-${t.data.table}-column-${(C=l.title)==null?void 0:C.toLowerCase().replace(" ","_")}`])},[c(n(B),{id:`s-${L(l.colOptions)}-${t.data.table}`,class:"opacity-0 !right-[-1px]",type:"source",position:n(V).Right,connectable:!1},null,8,["id","position"]),c(n(B),{id:`d-${L(l.colOptions)}-${t.data.table}`,class:"opacity-0 !left-[-1px]",type:"target",position:n(V).Left,connectable:!1},null,8,["id","position"]),k("div",Se,[c(g,{"column-meta":{uidt:"Links",colOptions:{type:l.relationType}}},null,8,["column-meta"]),c(b,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:m(()=>[S(v(l.title),1)]),default:m(()=>[S(" "+v(l.title),1)]),_:2},1024)])],2)):n(ne)(l.type)?(h(),A("div",{key:1,class:$(["nc-erd-table-node-column flex items-center gap-2",`nc-erd-table-node-${t.data.table}-column-${l.title}`])},[c(g,{"column-meta":{uidt:l.type}},null,8,["column-meta"]),c(b,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:m(()=>[S(v(l.title),1)]),default:m(()=>[S(" "+v(l.title),1)]),_:2},1024)],2)):(h(),A("div",{key:2,class:$(["nc-erd-table-node-column flex items-center gap-2",`nc-erd-table-node-${t.data.table}-column-${l.title}`])},[c(E,{"column-meta":{uidt:l.type}},null,8,["column-meta"]),c(b,{"show-on-truncate-only":"",class:"truncate text-sm"},{title:m(()=>[S(v(l.title),1)]),default:m(()=>[S(" "+v(l.title),1)]),_:2},1024)],2))],2)])}),128))])):U("",!0)],2)]),_:1},8,["modifier-key","disabled"])}}}),Le=Object.assign(ae(ze,[["__scopeId","data-v-74cf8138"]]),{__name:"AiErdTableNode"});function Ee(Y,z){const _=le([]),{theme:T}=ie(),L=we().domain([0,2]).range([T.value.primaryColor,T.value.accentColor]),p=new j.graphlib.Graph;p.setDefaultEdgeLabel(()=>({})),p.setGraph({rankdir:"LR",align:"UL",nodesep:50,ranksep:100});const t=R(()=>n(Y)),y=R(()=>n(z)),w=300,g=R(()=>y.value.showViews&&y.value.showAllColumns?50:40),b=R(()=>t.value.relationships.reduce((a,e)=>{const r=e.from,d=e.to,o={source:r,target:d,parentColId:r,childColId:d,modelId:r,type:e.type};return a.push(o),a},[]));function E({type:a,source:e,target:r,childColId:d,parentColId:o}){const i={[O.HAS_MANY]:"has many",[O.MANY_TO_MANY]:"many to many",[O.ONE_TO_ONE]:"one to one"};return[`[${e}] ${d} - ${i[a]} - ${o} [${r}]`,`${e} - ${i[a]} - ${r}`]}function x(){return t.value.tables.reduce((a,e)=>{const r=t.value.relationships.filter(o=>o.from===e.title||o.to===e.title).map(o=>({title:o.from===e.title?o.to:o.from,type:ce.Links,relationType:o.to===e.title&&o.type==="hm"?"bt":o.type,colOptions:{type:o.to===e.title&&o.type==="hm"?"bt":o.type,fk_child_column_id:o.from===e.title?o.to:o.from,fk_parent_column_id:o.from===e.title?o.from:o.to}})),d=e.columns.concat(r);return a.push({id:e.title,data:{table:e.title,showAllColumns:y.value.showAllColumns,columns:r,columnLength:d.length,color:""},type:"custom",position:{x:0,y:0}}),a},[])}function l(){return b.value.reduce((a,{source:e,target:r,childColId:d,parentColId:o,type:i,modelId:Z})=>{let N,s;(i===O.HAS_MANY||i==="oo")&&(N=d,s=o),i===O.MANY_TO_MANY&&(N=o,s=d);const[f,u]=E({source:e,target:r,type:i,childColId:d,parentColId:o});return a.push({id:`e-${N}-${e}-${s}-${r}-#${f}`,source:`${e}`,target:`${r}`,sourceHandle:`s-${N}-${e}`,targetHandle:`d-${s}-${r}`,type:"custom",markerEnd:{id:"arrow-colored",type:xe.ArrowClosed},data:{isManyToMany:i===O.MANY_TO_MANY,isOneToOne:i===O.ONE_TO_ONE,isSelfRelation:e===r&&N===s,label:f,simpleLabel:u,color:""}}),a},[])}const M=(a,e)=>({});return{elements:_,layout:async(a=!1)=>new Promise(e=>{_.value=[...x(),...l()];for(const s of _.value)if(G(s)){const u=s.data.columnLength,I=a?w*3:w,q=g.value+(a?250:u>0?g.value*u:g.value);p.setNode(s.id,{width:I,height:q})}else F(s)&&p.setEdge(s.source,s.target);j.layout(p);let r=1/0,d=1/0,o=-1/0,i=-1/0;for(const s of _.value)if(G(s)){const f=p.node(s.id),u=a?w*3:w,I=g.value+(a?250:s.data.columnLength>0?g.value*s.data.columnLength:g.value);r=Math.min(r,f.x-u/2),d=Math.min(d,f.y-I/2),o=Math.max(o,f.x+u/2),i=Math.max(i,f.y+I/2)}const Z=-(r+o)/2,N=-(d+i)/2;for(const s of _.value)if(G(s)){const f=L(p.predecessors(s.id).length),u=p.node(s.id);s.targetPosition=V.Left,s.sourcePosition=V.Right,s.position={x:u.x+Z,y:u.y+N},s.class=["rounded-lg border-1 border-gray-200 shadow-lg"].join(" "),s.data.color=f,s.style=I=>(I.selected,M())}else if(F(s)){const f=_.value.find(u=>u.id===s.source);if(f){const u=f.data.color;s.data.color=u,s.markerEnd.color=`#${re(u).toHex()}`}}e()})}}const Me=D({__name:"Flow",props:{aiBaseSchema:{},config:{}},setup(Y){const z=Y,{aiBaseSchema:_,config:T}=de(z),{$destroy:L,fitView:p,viewport:t,setMaxZoom:y,onNodeDoubleClick:w,zoomIn:g,zoomOut:b}=X({minZoom:.05,maxZoom:2}),{layout:E,elements:x}=Ee(_,T),l=R(()=>t.value.zoom<.15);async function M(){await E(l.value),await he(),setTimeout(()=>{p({duration:200,padding:.1,minZoom:t.value.zoom||1,maxZoom:t.value.zoom||1})},100)}function C(a){p({nodes:a?[a]:void 0,duration:200,minZoom:.2})}return w(({node:a})=>{l.value&&C(),setTimeout(()=>{C(a.id)},250)}),P(_,M,{flush:"post",immediate:!0}),P(l,async a=>{E(a).then(()=>{a&&p({duration:300,padding:.1,minZoom:t.value.zoom,maxZoom:t.value.zoom})})}),P(x,a=>{a.length>3?y(2):y(1.25)}),ue(L),(a,e)=>{const r=pe,d=Le,o=be;return h(),H(n(Ce),{modelValue:n(x),"onUpdate:modelValue":e[2]||(e[2]=i=>ge(x)?x.value=i:null),class:"nc-erd-flow"},{"node-custom":m(({data:i,dragging:Z})=>[c(d,{data:i,dragging:Z,"show-skeleton":n(l)},null,8,["data","dragging","show-skeleton"])]),"edge-custom":m(i=>[c(o,_e(i,{"show-skeleton":n(l)}),null,16,["show-skeleton"])]),default:m(()=>[c(n($e),{class:"bg-transparent rounded-lg shadow-md border-1 border-gray-200 !right-13 flex items-center",position:n(W).TopRight,"show-fit-view":!1,"show-interactive":!1},{"control-zoom-in":m(()=>[k("div",{class:"nc-erd-zoom-btn rounded-l-lg h-9 !px-2 flex items-center",onClick:e[0]||(e[0]=(...i)=>n(g)&&n(g)(...i))},[c(r,{icon:"plus"})])]),"control-zoom-out":m(()=>[k("div",{class:"nc-erd-zoom-btn border-l-1 border-gray-200 rounded-r-lg h-9 !px-2 flex items-center",onClick:e[1]||(e[1]=(...i)=>n(b)&&n(b)(...i))},[c(r,{icon:"minus"})])]),_:1},8,["position"]),c(n(ke),{size:n(l)?2:void 0,gap:n(l)?50:void 0},null,8,["size","gap"]),c(fe,{name:"layout"},{default:m(()=>[n(l)&&n(T).showAllColumns?(h(),H(n(Te),{key:0,position:n(W).BottomCenter,class:"color-transition z-5 cursor-pointer rounded shadow-sm text-slate-400 font-semibold px-4 py-2 bg-slate-100/50 hover:text-slate-900 hover:ring hover:ring-accent hover:ring-opacity-100 hover:bg-slate-100/90",onClick:C},{default:m(()=>[S(v(a.$t("labels.zoomInToViewColumns")),1)]),_:1},8,["position"])):U("",!0)]),_:1}),me(a.$slots,"default")]),_:3},8,["modelValue"])}}}),Ze=Object.assign(Me,{__name:"AiErdFlow"});export{Ze as default};
