import{e as ae,G as _,fT as oe,r as v,kO as le,aE as ne,J as se,aZ as ie,jd as ue,gD as ce,as as re,cd as de,f as pe,a9 as ve,n as g,ik as d,hL as fe,fq as me,c as _e,o as h,b as ge,w as k,I as y,aT as he,L as e,a1 as we,N as be,K as V,M as Ie,aJ as ke,ap as ye,a as Oe,t as j,d as N,ag as xe,hM as Re,fs as A,a5 as $,a4 as G,h9 as Ae,_ as Ce}from"./DOFFjK0_.js";import{a as Ue}from"./4PLl4EP6.js";import{e as P}from"./D2QgEzTv.js";import{u as Se}from"./BClTqpVB.js";import{u as Ee}from"./DmoodaOn.js";import"./SJHyi9T4.js";import"./DcFNOSET.js";import"./boyBAVNN.js";const je={class:"text-[13px] truncate font-medium"},Be=ae({__name:"Button",setup(Te){const t=_(oe),C=_(le,v()),{currentRow:w}=Ue(),{generateRows:D,generatingRows:b,generatingColumnRows:I,generatingColumns:U,aiIntegrations:F}=ne(),{appInfo:B}=se(),p=_(ie,v()),W=_(ue,v(!1)),q=_(ce,v(!1)),{isUIAllowed:O}=re(),x=_(de,v(!1)),{$api:z}=pe(),{t:J}=ve(),K=g(()=>{var a;return P((a=w.value)==null?void 0:a.row,p.value.columns)}),{runScript:Z,activeExecutions:H,fieldIDRowMapping:Q}=Se(),X=Ee(),{loadAutomation:Y}=X,f=v(!1),c=g(()=>{var a,n;if((a=p.value)!=null&&a.columns)return P((n=w.value)==null?void 0:n.row,p.value.columns)}),S=g(()=>{var a,n;return((n=(a=t.value)==null?void 0:a.colOptions)==null?void 0:n.type)===d.Ai}),T=g(()=>{var n,s;return S.value?!!((s=(n=t.value)==null?void 0:n.colOptions)==null?void 0:s.fk_integration_id):!0}),ee=async()=>{var r,u,l;if(!((r=p==null?void 0:p.value)!=null&&r.id)||!p.value.columns||!((u=t==null?void 0:t.value)!=null&&u.id)||!c.value)return;const a=Ae((l=t.value.colOptions)==null?void 0:l.output_column_ids)&&t.value.colOptions.output_column_ids.split(",").length>0?t.value.colOptions.output_column_ids.split(","):[],n=a.map(o=>{var m;return(m=p.value)==null?void 0:m.columnsById[o]});b.value.push(c.value),I.value.push(t.value.id),U.value.push(...a??[]);const s=await D(p.value.id,t.value.id,[c.value]);if(s!=null&&s.length){const o=s[0];if(a)for(const m of n)m&&w.value.row&&(w.value.row[m.title]=o[m.title])}b.value=b.value.filter(o=>o!==c.value),I.value=I.value.filter(o=>o!==t.value.id),U.value=U.value.filter(o=>!(a!=null&&a.includes(o)))},L=v(""),M=g(()=>{var a;return((a=H.value.get(L.value))==null?void 0:a.status)==="running"||Q.value.get(`${c.value}:${t.value.id}`)==="running"}),E=v(""),R=g(()=>{var a,n,s,r,u;if(t.value.colOptions.type===d.Url){let l=fe((a=C.value)==null?void 0:a.url);try{l=decodeURI(l)===l?encodeURI(l):l}catch{l=encodeURI(l)}const o=me(l,{require_tld:!((n=B.value)!=null&&n.allowLocalUrl)});return E.value=o?"":J("msg.error.invalidURL"),{href:l,target:"_blank",...(s=t.value)!=null&&s.colOptions.error||!o?{disabled:!0}:{}}}else{if(t.value.colOptions.type===d.Webhook)return{disabled:x.value||!O("hookTrigger")||f.value||!t.value.colOptions.fk_webhook_id||!((r=C.value)!=null&&r.fk_webhook_id)};if(t.value.colOptions.type===d.Script)return{disabled:x.value||M.value||!O("dataEdit")||f.value};if(t.value.colOptions.type===d.Ai)return{disabled:x.value||!O("dataEdit")||!T.value||f.value||c.value&&b.value.includes(c.value)&&((u=t.value)==null?void 0:u.id)&&I.value.includes(t.value.id)}}}),i=v(null),te=async()=>{var n,s,r,u;const a=t.value.colOptions;if(i.value=null,a.type===d.Url)Re((n=R.value)==null?void 0:n.href,(s=R.value)==null?void 0:s.target,(r=B.value)==null?void 0:r.allowLocalUrl);else if(a.type===d.Webhook)try{f.value=!0,await z.dbTableWebhook.trigger((u=C.value)==null?void 0:u.fk_webhook_id,K.value),i.value={status:"success"},A(2e3).then(()=>{i.value=null})}catch(l){console.log(l);const o=await $(l);G.error(o),i.value={status:"error",tooltip:o},A(3e3).then(()=>{i.value=null})}finally{f.value=!1}else if(a.type===d.Ai)await ee();else if(a.type===d.Script)try{f.value=!0;const l=await Y(a.fk_script_id),o=await Z(l,w.value.row,{pk:c.value,fieldId:t.value.id});L.value=o,i.value={status:"success"},A(2e3).then(()=>{i.value=null})}catch(l){console.log(l);const o=await $(l);G.error(o),i.value={status:"error",tooltip:o},A(3e3).then(()=>{i.value=null})}finally{f.value=!1}};return(a,n)=>{var l;const s=Ie,r=ke,u=ye;return h(),_e("div",{class:xe([{"justify-center":e(W)&&!e(q)},"w-full flex items-center"])},[ge(u,{disabled:e(S)?e(T)||e(x)||!e(O)("dataEdit"):!e(E)&&!((l=e(i))!=null&&l.tooltip),class:"flex"},{title:k(()=>{var o;return[N(j(e(S)?e(F).length?a.$t("tooltip.aiIntegrationReConfigure"):a.$t("tooltip.aiIntegrationAddAndReConfigure"):((o=e(i))==null?void 0:o.tooltip)||e(E)),1)]}),default:k(()=>[(h(),y(he(e(t).colOptions.type===e(d).Url?"a":"button"),we(e(R),{"data-testid":"nc-button-cell",class:[[`${e(t).colOptions.color??"brand"} ${e(t).colOptions.theme??"solid"}`,{"!w-6":!e(t).colOptions.label,disabled:e(R).disabled}],"nc-cell-button nc-button-cell-link btn-cell-colors truncate flex items-center h-6"],onClick:be(te,["prevent"])}),{default:k(()=>{var o;return[e(i)?(h(),y(s,{key:0,icon:e(i).status==="success"?"ncCheck":"ncInfo",class:"w-4 h-4 flex-none text-current"},null,8,["icon"])):e(f)||e(M)||e(c)&&e(b).includes(e(c))&&((o=e(t))!=null&&o.id)&&e(I).includes(e(t).id)?(h(),y(r,{key:1,class:"flex w-4 h-4 !text-current",size:"medium"})):e(t).colOptions.icon?(h(),y(s,{key:2,icon:e(t).colOptions.icon,class:"!w-4 min-w-4 min-h-4 !h-4"},null,8,["icon"])):V("",!0),e(t).colOptions.label?(h(),y(u,{key:3,class:"!truncate","show-on-truncate-only":""},{title:k(()=>[N(j(e(t).colOptions.label),1)]),default:k(()=>[Oe("span",je,j(e(t).colOptions.label),1)]),_:1})):V("",!0)]}),_:1},16,["class"]))]),_:1},8,["disabled"])],2)}}}),Fe=Object.assign(Ce(Be,[["__scopeId","data-v-9c9be7b8"]]),{__name:"VirtualCellButton"});export{Fe as default};
